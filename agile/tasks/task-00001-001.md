# Task T-00001-001: Data Preparation (Python/Pandas)

## Status: Done

## Overview
This task involved building a robust ETL pipeline to process Taiwan's Central Government Budget data for the years **ROC 97-114 (AD 2008-2025)**. The goal was to unify messy, heterogeneous Excel files into clean, machine-readable CSVs for the frontend application.

## Deliverables
All trusted data is now located in `data/unified/`:
1.  **`budget_all.csv`** (121,116 rows): The main dataset containing Revenue and Expenditure items.
    *   **Note**: Preserves hierarchical structure (contains both parent totals and child items).
    *   **Schema**: `year`, `type`, `category_1`, `category_2`, `item_name`, `account_name`, `amount`, `source_file`.
2.  **`funds_all.csv`** (1236 rows): Special Funds (Non-Profit / Operation Funds).
    *   **Cleaning**: Filtered out "Total" lines to keep only leaf-node funds.
3.  **`summary_all.csv`** (252 rows): High-level YoY comparison data.
    *   **Cleaning**: Filtered out "Total Revenue/Expenditure" and "Surplus" rows to prevent double counting.

## Technical Implementation (`src/scripts/etl_budget.py`)

### core Challenges & Solutions
1.  **File Format Variations**:
    *   **Issue**: Data spans 16 years. Older files are `.xls` (Format 97-2003), newer are `.xlsx`. some years use strictly numeric filenames (e.g., Year 99).
    *   **Solution**: Implemented **Content-Based Identification**. The script opens each file and scans the top 20 rows for keywords (`機關`, `歲入`, `基金`, `總統府`, `稅課`) to identify the file type regardless of filename.

2.  **Schema Drift**:
    *   **Issue**: Header rows appeared at different lines (Row 0 for Year 114, Row 3-5 for Year 110). Column names changed slightly (`科目名稱` vs `名稱及編號`).
    *   **Solution**: Created a generic `process_generic` function that dynamically searches for column indices like 'Code', 'Name', 'Amount' using multiple aliases.

3.  **Data Quality (Double Counting)**:
    *   **Issue**: Source files for Funds and Summaries included aggregate rows (e.g., "Total Budget").
    *   **Solution**: Implemented strict filters for `funds_all.csv` and `summary_all.csv` to exclude rows containing "Total", "Surplus", or missing sub-names.

### Execution
To reproduce the dataset:
```bash
python src/scripts/etl_budget.py
```
This script iterates through `docs/tw-finance/97` to `114`, processes valid files, converts years to AD, and exports the unified CSVs.
